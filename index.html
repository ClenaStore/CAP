<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aprovação de Parcelas – F360</title>

  <link href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.0.6/css/pico.min.css" rel="stylesheet">
  <style>
    :root { --brand:#2457f5; }
    header {
      background: var(--brand); color: #fff; padding: 18px 16px; margin-bottom: 12px;
      box-shadow: 0 3px 12px rgba(0,0,0,.06);
    }
    h1 { margin: 0; font-size: 1.22rem; letter-spacing:.2px }
    .toolbar { gap: .6rem; align-items:end }
    .toolbar label { font-size:.82rem; color:#6b7280 }
    .pill { background:#eef2ff;border:1px solid #dbe2fe;padding: 4px 10px;border-radius:999px;color:#1e40af;font-weight:600 }
    .muted { color:#637082 }
    .badge { background:#e5e7eb; border-radius:12px; padding:.15rem .55rem; font-size:.78rem }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace }
    .table-wrap { overflow:auto; border-radius:12px; border:1px solid #e5e7eb }
    .error { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:.85rem }
    .row-actions button { margin-right:.3rem }
    .loading {
      display: inline-flex; align-items:center; gap:.5rem;
    }
    .loading .dot {
      width: 8px; height:8px; border-radius: 999px; background:#c7d2fe; animation:b .9s infinite alternate;
    }
    .loading .dot:nth-child(2){animation-delay:.2s}
    .loading .dot:nth-child(3){animation-delay:.4s}
    @keyframes b { to { transform: translateY(-3px); background:#93c5fd } }
    .sticky-tools { position:sticky; top:0; z-index:5; background:#fff; padding:6px 0 10px; border-bottom:1px solid #eef2f7 }
  </style>
</head>
<body>
  <header>
    <h1>Aprovação de Parcelas – F360</h1>
  </header>

  <main class="container">

    <section class="sticky-tools">
      <div class="grid toolbar">
        <div>
          <label for="tipo">Tipo:</label>
          <select id="tipo">
            <option>Ambos</option>
            <option>Despesa</option>
            <option>Receita</option>
          </select>
        </div>

        <div>
          <label for="tipoDatas">Tipo de Datas:</label>
          <select id="tipoDatas">
            <option>Vencimento</option>
            <option>Emissão</option>
            <option>Competência</option>
            <option>Liquidação</option>
            <option value="LiquidacaoSistema">LiquidacaoSistema</option>
            <option>Atualização</option>
          </select>
        </div>

        <div>
          <label for="status">Status:</label>
          <select id="status">
            <option>Aberto</option>
            <option>AbertoAVencer</option>
            <option>AbertoVencidos</option>
            <option>Liquidado</option>
            <option>Baixado</option>
            <option>Aprovados</option>
            <option>PendentesDeAprovacao</option>
            <option>Renegociados</option>
            <option>LiquidadoConciliado</option>
            <option>Agendado</option>
            <option>AbertoNaoAgendados</option>
            <option>NaoVinculadoComDDA</option>
            <option value="Liquidado Pendente">Liquidado Pendente</option>
            <option>Todos</option>
          </select>
        </div>

        <div>
          <label for="inicio">Início:</label>
          <input id="inicio" type="date">
        </div>

        <div>
          <label for="fim">Fim:</label>
          <input id="fim" type="date">
        </div>

        <div style="display:flex;gap:.4rem">
          <button id="btnAplicar" class="contrast">Aplicar filtros</button>
          <button id="btn31" class="secondary">Últimos 31 dias</button>
          <button id="btnDebug" class="secondary">Ver debug</button>
        </div>

        <div class="grid" style="grid-template-columns: 1fr auto; gap:.6rem">
          <input id="q" type="search" placeholder="Pesquisar por fornecedor, histórico ou empresa…" />
          <span id="count" class="pill">0 itens</span>
        </div>
      </div>
      <small id="msg" class="muted"></small>
    </section>

    <article id="debug" hidden>
      <details open>
        <summary>Diagnóstico</summary>
        <pre id="debugContent" class="error"></pre>
      </details>
    </article>

    <article class="table-wrap">
      <table role="grid">
        <thead>
          <tr>
            <th>Empresa</th>
            <th>Fornecedor</th>
            <th>Vencimento</th>
            <th>Meio de Pagamento</th>
            <th>Histórico</th>
            <th>Valor</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7" class="muted">Carregue os filtros para listar…</td></tr>
        </tbody>
      </table>
    </article>

  </main>

  <script>
    // 1) TROQUE pela URL da sua implantação do Apps Script (termina com /exec)
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwSUx__bmkV8_jy5EOnIUifIeuhhoUpxMd45PZhw5SQTPVMTqrkcp4McLFkONK96WBZ/exec';

    // ---------------- util ----------------
    const $$ = (sel, el=document)=>el.querySelector(sel);
    const $$$ = (sel, el=document)=>Array.from(el.querySelectorAll(sel));
    const fmtBRL = v => (new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'})).format(Number(v||0));
    const toISO = (d)=>d ? new Date(d).toISOString().slice(0,10) : '';
    const today = ()=>toISO(new Date());
    const minusDays = n=>toISO(new Date(Date.now() - n*864e5));

    // ---------------- estado ----------------
    let allRows = [];

    // ---------------- eventos ----------------
    window.addEventListener('load', () => {
      // datas padrão
      $('#inicio').value = minusDays(31);
      $('#fim').value    = today();

      $('#btn31').addEventListener('click', e=>{
        e.preventDefault();
        $('#inicio').value = minusDays(31);
        $('#fim').value    = today();
        apply();
      });
      $('#btnAplicar').addEventListener('click', e=>{ e.preventDefault(); apply(); });
      $('#btnDebug').addEventListener('click', showDebug);
      $('#q').addEventListener('input', applyFilterLocal);

      // primeiro load
      apply();
    });

    function $(sel){ return document.querySelector(sel); }

    function showMessage(text, type='info'){
      const el = $('#msg');
      el.textContent = text || '';
      el.style.color = (type==='error'?'#b91c1c': (type==='warn'?'#b45309': '#64748b'));
    }

    function setLoading(on){
      if(on){
        showMessage('');
        $('#count').innerHTML = `<span class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> carregando...</span>`;
      }
    }

    async function showDebug(){
      try{
        const r = await fetch(WEBAPP_URL + '?debug=1', { mode:'cors' });
        const j = await r.json();
        $('#debug').hidden = false;
        $('#debugContent').textContent = JSON.stringify(j, null, 2);
      }catch(err){
        $('#debug').hidden = false;
        $('#debugContent').textContent = 'Erro ao consultar debug:\n' + String(err);
      }
    }

    async function apply(){
      setLoading(true);
      $('#tbody').innerHTML = `<tr><td colspan="7" class="muted">Carregando…</td></tr>`;

      const params = new URLSearchParams({
        tipo:       $('#tipo').value || 'Ambos',
        tipoDatas:  $('#tipoDatas').value || 'Vencimento',
        status:     $('#status').value || 'Aberto',
        inicio:     $('#inicio').value,
        fim:        $('#fim').value
      });

      try{
        const r = await fetch(WEBAPP_URL + '?' + params.toString(), { mode:'cors' });
        const j = await r.json();

        if(!j || j.ok === false){
          const detail = j && (j.body || j.detail || j.error) ? ('\n' + JSON.stringify(j.body || j.detail || j.error, null, 2)) : '';
          showMessage('Erro ao consultar API' + (j?.status?` (${j.status})`:'') + ': ' + (j?.error || 'verifique as credenciais') + detail, 'error');
          $('#tbody').innerHTML = `<tr><td colspan="7"><pre class="error">${(j && (j.detail||j.error||JSON.stringify(j,null,2)))||'Falha'}</pre></td></tr>`;
          $('#count').textContent = '0 itens';
          allRows = [];
          return;
        }

        // suportar formatos do backend
        const payload = j.data || j; // nosso GAS devolve {ok, data}
        const result  = payload?.Result || payload?.result || payload;
        const parcelas = result?.Parcelas || result?.parcelas || [];

        allRows = toRows(parcelas);
        render(allRows);
        showMessage(parcelas.length ? '' : 'Nenhum resultado (ou filtro não retornou itens).');
      }catch(err){
        showMessage('Erro: ' + String(err), 'error');
        $('#tbody').innerHTML = `<tr><td colspan="7"><pre class="error">${String(err)}</pre></td></tr>`;
        $('#count').textContent = '0 itens';
        allRows = [];
      }
    }

    // converte estrutura da API F360 para linhas simples
    function toRows(items){
      return (items||[]).map(p => {
        const empresa   = p?.DadosDoTitulo?.Empresa?.Nome || p?.DadosDoTitulo?.Empresa || '';
        const forn      = p?.DadosDoTitulo?.ClienteFornecedor?.Nome || p?.DadosDoTitulo?.ClienteFornecedor || '';
        const hist      = p?.DadosDoTitulo?.Observacao || p?.Observacoes || '';
        const meio      = p?.MeioDePagamento || p?.Meio || '';
        const valor     = p?.ValorLiquido ?? p?.ValorBruto ?? 0;
        const status    = p?.Status || '';
        const venc      = p?.Vencimento || '';

        return {
          empresa, forn, venc, meio, hist, valor, status
        };
      });
    }

    function render(rows){
      const q = ($('#q').value || '').trim().toLowerCase();
      const filtered = q ? rows.filter(r =>
        (r.empresa||'').toLowerCase().includes(q) ||
        (r.forn||'').toLowerCase().includes(q) ||
        (r.hist||'').toLowerCase().includes(q)
      ) : rows;

      if(!filtered.length){
        $('#tbody').innerHTML = `<tr><td colspan="7" class="muted">Nada encontrado.</td></tr>`;
        $('#count').textContent = '0 itens';
        return;
      }

      const html = filtered.map(r => `
        <tr>
          <td>${esc(r.empresa)}</td>
          <td>${esc(r.forn)}</td>
          <td>${esc(fmtDateBR(r.venc))}</td>
          <td>${esc(r.meio)}</td>
          <td>${esc(r.hist)}</td>
          <td class="mono">${fmtBRL(r.valor)}</td>
          <td><span class="badge">${esc(r.status)}</span></td>
        </tr>
      `).join('');

      $('#tbody').innerHTML = html;
      $('#count').textContent = `${filtered.length} ${filtered.length===1?'item':'itens'}`;
    }

    function applyFilterLocal(){ render(allRows); }

    function fmtDateBR(s){
      if(!s) return '';
      // aceita yyyy-MM-dd ou yyyy-MM-ddTHH:mm
      const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})/);
      if(m) return `${m[3]}/${m[2]}/${m[1]}`;
      // aceita ISO
      try { return new Date(s).toLocaleDateString('pt-BR'); } catch { return s; }
    }
    function esc(s){ return String(s ?? '').replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
  </script>
</body>
</html>
